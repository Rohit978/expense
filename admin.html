<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Admin Console - TrackKro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .card { background-color: #1F2937; }
        .nav-link.active { color: #818CF8; border-bottom-color: #818CF8; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
        .loader { border: 4px solid #4B5563; border-top: 4px solid #6366F1; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 5rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .filter-btn.active { background-color: #4F46E5; color: white; }
    </style>
</head>
<body class="text-gray-200">

    <main class="max-w-7xl mx-auto p-4 sm:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-white">Master Admin Console</h1>
            <nav class="mt-4 border-b border-gray-700" id="main-nav">
                <a href="#" data-section="dashboard" class="nav-link inline-block py-3 px-4 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent">Dashboard</a>
                <a href="#" data-section="users" class="nav-link inline-block py-3 px-4 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent">User Management</a>
                <a href="#" data-section="expenses" class="nav-link inline-block py-3 px-4 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent">Expense Management</a>
                <a href="#" data-section="settings" class="nav-link inline-block py-3 px-4 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent">Settings</a>
            </nav>
        </header>
        
        <div id="content-container">
            </div>
    </main>

    <div id="user-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center modal-backdrop p-4">...</div>
    <div id="expense-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4">...</div>


    <template id="dashboard-template">
        <section>
            <h2 class="text-3xl font-bold text-white mb-6">At a Glance</h2>
            <div id="stats-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card p-6 rounded-xl shadow-lg"><p class="text-sm text-gray-400">Total Users</p><p id="total-users" class="text-3xl font-bold">0</p></div>
                <div class="card p-6 rounded-xl shadow-lg"><p class="text-sm text-gray-400">Pending Expenses</p><p id="pending-expenses" class="text-3xl font-bold">0</p></div>
                <div class="card p-6 rounded-xl shadow-lg"><p class="text-sm text-gray-400">Approved This Month</p><p id="approved-value" class="text-3xl font-bold">$0.00</p></div>
                <div class="card p-6 rounded-xl shadow-lg"><p class="text-sm text-gray-400">Active Invites</p><p id="active-invites" class="text-3xl font-bold">0</p></div>
            </div>
        </section>
    </template>

    <template id="users-template">
        <section class="card p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Manage Users</h2>
                <button onclick="openUserModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">+ Add User</button>
            </div>
            <div id="user-table-container" class="overflow-x-auto"></div>
        </section>
    </template>

    <template id="expenses-template">
        <section class="card p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Manage Expenses</h2>
                <div id="filter-buttons" class="flex space-x-2">
                    <button class="filter-btn px-4 py-2 text-sm font-medium rounded-lg bg-gray-700 hover:bg-gray-600" data-status="All">All</button>
                    <button class="filter-btn px-4 py-2 text-sm font-medium rounded-lg bg-gray-700 hover:bg-gray-600 active" data-status="Pending">Pending</button>
                    <button class="filter-btn px-4 py-2 text-sm font-medium rounded-lg bg-gray-700 hover:bg-gray-600" data-status="Approved">Approved</button>
                    <button class="filter-btn px-4 py-2 text-sm font-medium rounded-lg bg-gray-700 hover:bg-gray-600" data-status="Rejected">Rejected</button>
                </div>
            </div>
            <div id="expense-table-container" class="overflow-x-auto"></div>
        </section>
    </template>

    <template id="settings-template">
        <section class="card p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold text-white mb-6">Company Settings</h2>
            <form id="settings-form">
                <div class="mb-4">
                    <label for="company-name" class="block text-sm font-medium text-gray-400 mb-1">Company Name</label>
                    <input type="text" id="company-name" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white">
                </div>
                <div class="mb-6">
                    <label for="default-currency" class="block text-sm font-medium text-gray-400 mb-1">Default Currency</label>
                    <select id="default-currency" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2 text-white">
                        <option>USD</option>
                        <option>EUR</option>
                        <option>GBP</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Save Settings</button>
            </form>
        </section>
    </template>

    <script>
        // --- CONFIG & STATE ---
        const API_BASE_URL = 'http://localhost:3001/api';
        let state = {
            users: [],
            expenses: [],
            settings: {},
            invites: [], // Assuming you have an endpoint for this
            currentView: 'dashboard',
            currentExpenseFilter: 'Pending'
        };

        // --- CORE APP LOGIC ---
        async function fetchInitialData() {
            const container = document.getElementById('content-container');
            container.innerHTML = `<div class="loader"></div>`;
            const token = localStorage.getItem('authToken');
            if (!token) { window.location.href = './login.html'; return; }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/dashboard-all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to fetch initial data.');
                
                const data = await response.json();
                state.users = data.users;
                state.expenses = data.expenses;
                state.settings = data.settings;
                state.invites = data.invites || [];

                handleNavigation('dashboard'); // Render the initial view
            } catch (error) {
                container.innerHTML = `<p class="text-red-400 text-center">${error.message}</p>`;
            }
        }

        function handleNavigation(sectionName) {
            state.currentView = sectionName;
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.section === sectionName);
            });
            
            const container = document.getElementById('content-container');
            const template = document.getElementById(`${sectionName}-template`);
            container.innerHTML = template.innerHTML;

            // Render the content for the active view
            switch (sectionName) {
                case 'dashboard': renderDashboardView(); break;
                case 'users': renderUserManagementView(); break;
                case 'expenses': renderExpenseManagementView(); break;
                case 'settings': renderSettingsView(); break;
            }
            lucide.createIcons();
        }

        // --- RENDER FUNCTIONS FOR EACH VIEW ---
        function renderDashboardView() {
            document.getElementById('total-users').textContent = state.users.length;
            document.getElementById('pending-expenses').textContent = state.expenses.filter(e => e.status === 'Pending').length;
            const approvedValue = state.expenses.filter(e => e.status === 'Approved').reduce((sum, e) => sum + parseFloat(e.amount), 0);
            document.getElementById('approved-value').textContent = `$${approvedValue.toFixed(2)}`;
            document.getElementById('active-invites').textContent = state.invites.filter(i => !i.is_used).length;
        }

        function renderUserManagementView() {
            const container = document.getElementById('user-table-container');
            const userRows = state.users.map(user => `
                <tr class="hover:bg-gray-800/50">
                    <td class="p-4 text-sm font-medium text-white">${user.name}</td>
                    <td class="p-4 text-sm text-gray-300">${user.email}</td>
                    <td class="p-4 text-sm text-indigo-400">${user.role}</td>
                    <td class="p-4 text-right">
                        <button class="text-indigo-400 hover:text-indigo-300 mr-4">Edit</button>
                        <button class="text-red-400 hover:text-red-300">Delete</button>
                    </td>
                </tr>
            `).join('');
            
            container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-700">
                    <thead>...</thead>
                    <tbody class="divide-y divide-gray-800">${userRows}</tbody>
                </table>
            `;
        }
        
        function renderExpenseManagementView() {
            const container = document.getElementById('expense-table-container');
            const filteredExpenses = state.currentExpenseFilter === 'All' ? state.expenses : state.expenses.filter(e => e.status === state.currentExpenseFilter);
            
            const expenseRows = filteredExpenses.map(expense => `
                 <tr class="hover:bg-gray-800/50 cursor-pointer">
                    <td class="p-4 text-sm font-medium text-white">${expense.employee_name || 'N/A'}</td>
                    <td class="p-4 text-sm text-gray-300">${new Date(expense.expense_date).toLocaleDateString()}</td>
                    <td class="p-4 text-sm font-bold text-indigo-300">$${parseFloat(expense.amount).toFixed(2)}</td>
                    <td class="p-4 text-sm"><span class="px-3 py-1 text-xs font-semibold rounded-full">${expense.status}</span></td>
                </tr>
            `).join('');
            
             container.innerHTML = `
                <table class="min-w-full divide-y divide-gray-700">
                    <thead>...</thead>
                    <tbody class="divide-y divide-gray-800">${expenseRows}</tbody>
                </table>
            `;
             // Add event listeners for filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.status === state.currentExpenseFilter);
                btn.onclick = (e) => {
                    state.currentExpenseFilter = e.target.dataset.status;
                    renderExpenseManagementView();
                };
            });
        }
        
        function renderSettingsView() {
            document.getElementById('company-name').value = state.settings.company_name || '';
            document.getElementById('default-currency').value = state.settings.default_currency || 'USD';
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchInitialData();
            document.getElementById('main-nav').addEventListener('click', (e) => {
                if (e.target.matches('.nav-link')) {
                    e.preventDefault();
                    handleNavigation(e.target.dataset.section);
                }
            });
        });
    </script>

</body>
</html>